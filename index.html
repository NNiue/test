<!DOCTYPE html>
<html>
<head>
    <title>精准Lora装修生成系统</title>
    <style>
        .model-selector {
            width: 300px;
            padding: 10px;
            margin: 20px 0;
            border: 2px solid #2A5CAA;
            border-radius: 8px;
        }
        #previewContainer {
            border: 3px dashed #2A5CAA;
            width: 400px;
            height: 300px;
            margin: 20px 0;
        }
        .status-indicator {
            padding: 8px 15px;
            background: #f0f0f0;
            border-radius: 20px;
            margin: 10px 0;
        }
        .loading-dots:after {
            content: '...';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
    </style>
</head>
<body>
    <h1>精准Lora装修生成系统</h1>

    <!-- 模型选择 -->
    <select class="model-selector" id="modelSelect">
        <option value="Modern_Luxe_done">现代奢华风（大理石/金属饰面）</option>
        <option value="Scandinavian_Style_done">北欧极简风（原木/几何线条）</option>
        <option value="Sophisticated_Gray_Style_done">高级灰风格（混凝土/隐藏照明）</option>
        <option value="Taiwanese_Modern_Style_done">台式现代风（智能收纳/浅木纹）</option>
        <option value="eclectic_style_done">折衷混搭风（古董家具/撞色）</option>
        <option value="french_style_done">法式宫廷风（雕花线条/丝绒）</option>
        <option value="industrial_style_done">工业复古风（黄铜/皮革）</option>
        <option value="japanese_done">日式禅风（榻榻米/障子门）</option>
        <option value="loft_done">LOFT工业风（裸露管线/回收木材）</option>
        <option value="minimalism_done">极简主义（隐藏式收纳/纯平柜门）</option>
    </select>

    <!-- 输入系统 -->
    <div>
        <input type="file" id="roomPhoto" accept="image/*"
               onchange="previewImage(event)">
        <div id="previewContainer"></div>
    </div>

    <!-- 生成控制 -->
    <button onclick="startGeneration()" id="generateBtn">
        <span id="statusText">开始生成装修方案</span>
    </button>

    <!-- 结果展示 -->
    <div id="resultContainer"></div>

    <script>
        // 验证模型列表（与仓库文件完全一致）
        const VALID_MODELS = [
            'Modern_Luxe_done', 'Scandinavian_Style_done',
            'Sophisticated_Gray_Style_done', 'Taiwanese_Modern_Style_done',
            'eclectic_style_done', 'french_style_done', 'industrial_style_done',
            'japanese_done', 'loft_done', 'minimalism_done'
        ];

        // HuggingFace接口配置
        const HF_API = {
            endpoint: "https://api-inference.huggingface.co/models/NNiuNUll/my-lora-platform",
            headers: { Authorization: "Bearer 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" }
        };

        function previewImage(event) {
            const reader = new FileReader();
            reader.onload  = e => {
                const img = new Image();
                img.src  = e.target.result;
                img.style.maxWidth  = "100%";
                document.getElementById('previewContainer').innerHTML  = '';
                document.getElementById('previewContainer').appendChild(img);
            };
            reader.readAsDataURL(event.target.files[0]);
        }

        async function startGeneration() {
            const model = document.getElementById('modelSelect').value;
            const btn = document.getElementById('generateBtn');

            if (!VALID_MODELS.includes(model))  {
                alert("错误：模型不存在，请重新选择");
                return;
            }

            btn.disabled  = true;
            document.getElementById('statusText').innerHTML  =
                '<span class="loading-dots">模型加载中</span>';

            try {
                const formData = new FormData();
                formData.append('image',  document.getElementById('roomPhoto').files[0]);
                formData.append('parameters',  JSON.stringify({
                    model: model,
                    resolution: getResolutionByModel(model),
                    lora_path: `${model}/${model}.safetensors`,
                    config: `${model}/config.json`
                }));

                const response = await fetch(HF_API.endpoint,  {
                    method: 'POST',
                    headers: HF_API.headers,
                    body: formData
                });

                if (!response.ok)  throw new Error(`HTTP错误 ${response.status}`);

                const result = await response.json();
                showResults(result);

            } catch (error) {
                document.getElementById('statusText').textContent  =
                    `❌ 生成失败: ${error.message}`;
            } finally {
                btn.disabled  = false;
                document.getElementById('statusText').textContent  = "开始生成装修方案";
            }
        }

        function getResolutionByModel(model) {
            // 根据config.json 预定义的分辨率设置
            const resMap = {
                'Modern_Luxe_done': [1024, 768],
                'loft_done': [1366, 768],
                'japanese_done': [960, 640]
            };
            return resMap[model] || [1024, 768];
        }

        function showResults(data) {
            const container = document.getElementById('resultContainer');
            container.innerHTML  = data.images.map(img  => `
                <div style="margin:20px; display:inline-block">
                    <img src="data:image/png;base64,${img.base64}"
                         style="width:300px; border:2px solid #2A5CAA">
                    <div style="margin-top:10px">
                        <button onclick="downloadImage('${img.id}')"> 下载方案</button>
                        <span style="color:#666; margin-left:10px">分辨率: ${img.resolution}</span>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>