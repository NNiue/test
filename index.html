<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>智能装修生成器 VPN专版</title>
    <style>
        /* 新增VPN状态监测模块 */
        .vpn-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            background: linear-gradient(45deg, #4CAF50 30%, #8BC34A 100%);
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .vpn-indicator::before {
            content: "";
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ffffff80;
        }
        .vpn-indicator.connected::before  { background: #76FF03; }
        .vpn-indicator.disconnected::before  { background: #ff1744; }
    </style>
</head>
<body>
    <!-- 原有界面元素保持不变 -->

    <div class="vpn-indicator" id="vpnStatus">
        VPN状态检测中...
    </div>

    <script>
        // 动态代理配置（核心修改点）
        const VPN_CONFIG = {
            enable: true,           // 强制开启代理模式
            protocol: 'http',       // 适配主流VPN协议
            host: '127.0.0.1',      // 本地回环地址
            port: 7897,             // 用户指定端口
            retryCount: 3,          // 失败重试次数
            timeout: 25000          // 超时时间(ms)
        };

        // 代理状态检测器
        async function checkVPN() {
            const testAPI = 'https://huggingface.co/api/health';
            try {
                const testRes = await fetch(testAPI, {
                    mode: 'no-cors',
                    proxy: `${VPN_CONFIG.protocol}://${VPN_CONFIG.host}:${VPN_CONFIG.port}`
                });
                document.getElementById('vpnStatus').className  = 'vpn-indicator connected';
                document.getElementById('vpnStatus').innerHTML  = `
                    <span>VPN已连接</span>
                    <span>端口: ${VPN_CONFIG.port}</span>
                `;
                return true;
            } catch {
                document.getElementById('vpnStatus').className  = 'vpn-indicator disconnected';
                document.getElementById('vpnStatus').textContent  = 'VPN未连接';
                return false;
            }
        }

        // 重构的请求函数
        async function secureFetch(url, options) {
            let retry = 0;
            const controller = new AbortController();

            while (retry < VPN_CONFIG.retryCount)  {
                try {
                    const timeoutId = setTimeout(
                        () => controller.abort(),
                        VPN_CONFIG.timeout
                    );

                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal,
                        agent: new URL(`${VPN_CONFIG.protocol}://${VPN_CONFIG.host}:${VPN_CONFIG.port}`)
                    });

                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    if (++retry === VPN_CONFIG.retryCount)  throw error;
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }

        // 修改后的生成函数
        async function startGeneration() {
            if (!await checkVPN()) {
                showError('请先连接VPN');
                return;
            }

            try {
                // ...原有参数验证逻辑...

                const response = await secureFetch(
                    'https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-xxl-2025',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${HF_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    }
                );

                // ...结果处理不变...
            } catch (error) {
                console.error(`[VPN  ERROR] ${new Date().toLocaleString()}`, error);
                showError(`网络故障: ${error.message}`);
            }
        }

        // 启动VPN检测
        setInterval(checkVPN, 15000);
        checkVPN();
    </script>
</body>
</html>