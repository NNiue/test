<!DOCTYPE html>
<html>
<head>
    <title>LoRAç”Ÿæˆå™¨</title>
    <style>
        /* æ·»åŠ åŸºç¡€æ ·å¼é˜²æ­¢é¡µé¢é”™ä¹± */
        body { font-family: Arial; max-width: 600px; margin: 20px auto; padding: 20px; }
        input, select, textarea { display: block; margin: 10px 0; width: 100%; padding: 8px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; cursor: pointer; }
        #results img { width: 200px; margin: 10px; border: 1px solid #ddd; }
        #status { color: #d9534f; margin: 10px 0; }
    </style>
</head>
<body>
    <h2>LoRAå›¾ç‰‡ç”Ÿæˆå™¨</h2>
    <input type="file" id="imageInput" accept="image/*">
    <select id="modelSelect">
        <option value="https://huggingface.co/NNiuNUll/my-lora/resolve/main/1.safetensors">Model 1</option>
    </select>
    <input type="number" id="num" value="1" min="1" max="4">
    <textarea id="prompt" placeholder="ç¤ºä¾‹ï¼šä¸€åªç©¿ç€å®‡èˆªæœçš„çŒ«ï¼Œèµ›åšæœ‹å…‹é£æ ¼"></textarea>
    <button onclick="generate()">ç”Ÿæˆå›¾ç‰‡</button>
    <div id="status"></div>
    <div id="results"></div>

    <script>
        // ğŸ”¥ æ›¿æ¢ä¸ºä½ çš„Replicateå¯†é’¥
        const API_TOKEN = "r8_08OBQsEYr53cDskZ14O5mLaIWwgG3Ey0wpBtU";
        const SDXL_VERSION = "7762fd07cf82c948538e41f63f77d685e02b063e37e496e96eefd46c929f9bdc";

        async function generate() {
            const btn = document.querySelector('button');
            btn.disabled  = true;
            document.getElementById('status').textContent  = "æ­£åœ¨ç”Ÿæˆ...";

            try {
                // æ­¥éª¤1ï¼šæ£€æŸ¥å›¾ç‰‡æ˜¯å¦ä¸Šä¼ 
                const file = document.getElementById('imageInput').files[0];
                if (!file) throw new Error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼");

                // æ­¥éª¤2ï¼šè½¬æ¢å›¾ç‰‡ä¸ºBase64
                const imageBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload  = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                // æ­¥éª¤3ï¼šè°ƒç”¨API
                const response = await fetch("https://api.replicate.com/v1/predictions",  {
                    method: "POST",
                    headers: { "Authorization": `Token ${API_TOKEN}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        version: SDXL_VERSION,
                        input: {
                            prompt: document.getElementById('prompt').value  + ", é«˜æ¸…, 8K, ç”µå½±çº§å…‰å½±",
                            image: `data:image/png;base64,${imageBase64}`,
                            num_outputs: parseInt(document.getElementById('num').value),
                            lora_adapters: [{
                                url: document.getElementById('modelSelect').value,
                                weight: 1.2  // æ¨¡å‹å¼ºåº¦
                            }]
                        }
                    })
                });

                // æ­¥éª¤4ï¼šå¤„ç†ç»“æœ
                const data = await response.json();
                if (data.error)  throw new Error(data.error);

                // æ­¥éª¤5ï¼šè½®è¯¢è¿›åº¦
                const checkStatus = async () => {
                    const res = await fetch(`https://api.replicate.com/v1/predictions/${data.id}`,  {
                        headers: { "Authorization": `Token ${API_TOKEN}` }
                    });
                    const status = await res.json();
                    document.getElementById('status').textContent  = `çŠ¶æ€: ${status.status}  (é¢„è®¡è¿˜éœ€${status.metrics?.predict_time_remaining  || 20}ç§’)`;

                    if (status.status  === "succeeded") {
                        status.output.forEach(img  => {
                            document.getElementById('results').innerHTML  += `<img src="${img}">`;
                        });
                    } else if (status.status  !== "failed") {
                        setTimeout(checkStatus, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
                    }
                };
                await checkStatus();

            } catch (error) {
                document.getElementById('status').textContent  = "é”™è¯¯: " + error.message;
            } finally {
                btn.disabled  = false;
            }
        }
    </script>
</body>
</html>