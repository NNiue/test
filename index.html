<!DOCTYPE html>
<html>
<head>
    <title>LoRA图片生成</title>
</head>
<body>
    <input type="file" id="imageInput" accept="image/*">
    <select id="modelSelect">
        <option value="https://huggingface.co/NNiuNUll/my-lora/resolve/main/1.safetensors">Model 1</option>
<!--        <option value="模型2的RAW链接">Model 2</option>-->
    </select>
    <input type="number" id="num" value="1" min="1" max="4">
    <textarea id="prompt" placeholder="补充关键词"></textarea>
    <button onclick="generate()">生成</button>
    <div id="results"></div>

<script>
const API_TOKEN = "r8_8tGpTj5SOqleX5yFSVhlqMBL8iXIAha2dMMVa";
const SDXL_VERSION = "7762fd07cf82c948538e41f63f77d685e02b063e37e496e96eefd46c929f9bdc"; // 确认Replicate官网最新版本号

async function generate() {
  const file = document.getElementById('imageInput').files[0];
  const modelUrl = document.getElementById('modelSelect').value;
  const num = document.getElementById('num').value;
  const prompt = document.getElementById('prompt').value;

  // 将图片转为Base64
  const reader = new FileReader();
  reader.readAsDataURL(file);
  reader.onload = async () => {
    const imageBase64 = reader.result.split(',')[1]; // 移除data:image/...前缀

    // 调用Replicate API
    const response = await fetch("https://api.replicate.com/v1/predictions", {
      method: "POST",
      headers: {
        "Authorization": `Token ${API_TOKEN}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        version: SDXL_VERSION,
        input: {
          prompt: prompt,
          image: `data:image/png;base64,${imageBase64}`,
          num_outputs: parseInt(num),
          lora_adapters: [{ url: modelUrl, weight: 1 }]
        }
      })
    });

    const prediction = await response.json();
    if (prediction.error) return alert("错误: " + prediction.error);

    // 轮询获取结果
    const interval = setInterval(async () => {
      const statusRes = await fetch(`https://api.replicate.com/v1/predictions/${prediction.id}`, {
        headers: { "Authorization": `Token ${API_TOKEN}` }
      });
      const statusData = await statusRes.json();

      if (statusData.status === "succeeded") {
        clearInterval(interval);
        statusData.output.forEach(imgUrl => {
          document.getElementById('results').innerHTML += `<img src="${imgUrl}" style="width:200px">`;
        });
      }
    }, 1000);
  };
}
</script>
</body>
</html>