<!DOCTYPE html>
<html>
<head>
<title>LoRA生成器 - 2025新版</title>
<style>/* 样式保持不变 */</style>
</head>
<body>
<!-- 页面结构保持不变 -->

<script>
const API_TOKEN = "r8_08OBQsEYr53cDskZ14O5mLaIWwgG3Ey0wpBtU";
const SDXL_VERSION = "9ca5c5e2ab572d9a8a80df766a3b39b6";
const API_URL = "https://api.replicate.com/v2/predictions";

// 增强版CORS配置
const CORS_CONFIG = {
  mode: "cors",
  credentials: "omit",
  headers: {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Expose-Headers": "Content-Length, X-Error",
    "Authorization": `Token ${API_TOKEN}`,
    "Content-Type": "application/json",
    "X-Region": "CN",
    "CF-IPCountry": "CN" // 新增关键头
  }
};

async function generate() {
  const btn = document.querySelector('button');
  btn.disabled = true;
  document.getElementById('status').textContent = "正在生成...";

  try {
    // ...图片上传检查与Base64转换代码保持不变...

    // 关键修复1：处理OPTIONS预检
    const preflight = await fetch(API_URL, {
      method: "OPTIONS",
      ...CORS_CONFIG
    });
    if (!preflight.ok) throw new Error("预检请求失败: " + preflight.status);

    // 关键修复2：使用增强的CORS配置
    const response = await fetch(API_URL, {
      method: "POST",
      ...CORS_CONFIG,
      body: JSON.stringify({
        version: SDXL_VERSION,
        input: {
          prompt: document.getElementById('prompt').value + ", 超高清, 8K分辨率, 电影级细节",
          image: `data:image/png;base64,${imageBase64}`,
          num_outputs: parseInt(document.getElementById('num').value),
          lora_adapters: [{
            url: document.getElementById('modelSelect').value,
            weight: 0.8
          }]
        }
      })
    });

    // ...后续轮询逻辑保持不变...

  } catch (error) {
    document.getElementById('status').textContent = `错误: ${error.message}`;
    console.error("网络层错误:", {
      error: error.stack,
      request: { method: "POST", url: API_URL }
    });
  } finally {
    btn.disabled = false;
  }
}
</script>
</body>
</html>