<!DOCTYPE html>
<html>
<head>
    <title>LoRAç”Ÿæˆå™¨ - 2025æ–°ç‰ˆ</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 20px auto; padding: 20px; }
        input, select, textarea { display: block; margin: 10px 0; width: 100%; padding: 8px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; cursor: pointer; }
        #results img { width: 256px; margin: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #status { color: #d9534f; margin: 10px 0; }
    </style>
</head>
<body>
    <h2>LoRAå›¾ç‰‡ç”Ÿæˆå™¨ï¼ˆå›½é™…ç‰ˆAPIé€‚é…ï¼‰</h2>
    <input type="file" id="imageInput" accept="image/*">
    <select id="modelSelect">
        <option value="https://huggingface.co/NNiuNUll/my-lora/resolve/main/1.safetensors?download=true">Model  1</option>
    </select>
    <input type="number" id="num" value="1" min="1" max="4">
    <textarea id="prompt" placeholder="ç¤ºä¾‹ï¼šèµ›åšæœ‹å…‹é£æ ¼çš„æœªæ¥åŸå¸‚ï¼Œéœ“è™¹ç¯å…‰ï¼Œé›¨å¤œæ°›å›´"></textarea>
    <button onclick="generate()">ç”Ÿæˆå›¾ç‰‡</button>
    <div id="status"></div>
    <div id="results"></div>

    <script>
        // ğŸ”¥ é‡è¦ä¿®æ”¹ç‚¹1ï¼šä½¿ç”¨å›½é™…ç‰ˆç«¯ç‚¹
        const API_TOKEN = "r8_08OBQsEYr53cDskZ14O5mLaIWwgG3Ey0wpBtU";
        const SDXL_VERSION = "9ca5c5e2ab572d9a8a80df766a3b39b6";
        const API_URL = "https://api.replicate.com/v2/predictions";

        async function generate() {
            const btn = document.querySelector('button');
            btn.disabled  = true;
            document.getElementById('status').textContent  = "æ­£åœ¨ç”Ÿæˆ...";

            try {
                // é‡è¦ä¿®æ”¹ç‚¹2ï¼šå¢å¼ºæ–‡ä»¶æ ¡éªŒ
                const file = document.getElementById('imageInput').files[0];
                if (!file) throw new Error("è¯·å…ˆä¸Šä¼ å‚è€ƒå›¾ï¼");
                if (file.size  > 5 * 1024 * 1024) throw new Error("å›¾ç‰‡å¤§å°ä¸å¾—è¶…è¿‡5MB");

                // Base64è½¬æ¢å¢åŠ æ ¼å¼æ ¡éªŒ
                const imageBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload  = () => {
                        if (!/^data:image\/(png|jpeg|jpg);base64/.test(reader.result))  {
                            reject("ä»…æ”¯æŒPNG/JPEGæ ¼å¼");
                        }
                        resolve(reader.result.split(',')[1]);
                    };
                    reader.readAsDataURL(file);
                });

                // é‡è¦ä¿®æ”¹ç‚¹3ï¼šç§»é™¤X-Regionå¤´ï¼Œè°ƒæ•´æƒé‡å‚æ•°
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Authorization": `Token ${API_TOKEN}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        version: SDXL_VERSION,
                        input: {
                            prompt: document.getElementById('prompt').value  + ", è¶…é«˜æ¸…, 8Kåˆ†è¾¨ç‡, ç”µå½±çº§ç»†èŠ‚",
                            image: `data:image/png;base64,${imageBase64}`,
                            num_outputs: parseInt(document.getElementById('num').value),
                            lora_adapters: [{
                                url: document.getElementById('modelSelect').value,
                                weight: 1.2  // è°ƒæ•´ä¸ºå®‰å…¨èŒƒå›´
                            }]
                        }
                    })
                });

                // æ–°å¢é”™è¯¯å“åº”è§£æ
                if (response.status  === 402) throw new Error("APIé…é¢ä¸è¶³");
                if (response.status  === 403) throw new Error("APIå¯†é’¥æ— æ•ˆ");
                if (!response.ok)  throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}`);

                const data = await response.json();
                console.log("API å“åº”:", data);  // æ–°å¢è°ƒè¯•æ—¥å¿—

                // è½®è¯¢é€»è¾‘ä¼˜åŒ–ï¼ˆæ·»åŠ è¶…æ—¶æœºåˆ¶ï¼‰
                const startTime = Date.now();
                const checkStatus = async () => {
                    if (Date.now()  - startTime > 120000) {
                        throw new Error("ç”Ÿæˆè¶…æ—¶ï¼ˆ120ç§’ï¼‰");
                    }

                    const res = await fetch(`${API_URL}/${data.id}`,  {
                        headers: { "Authorization": `Token ${API_TOKEN}` }
                    });
                    const status = await res.json();

                    // æ–°å¢æœåŠ¡ç«¯é”™è¯¯æ•è·
                    if (status.error)  throw new Error(`æœåŠ¡ç«¯é”™è¯¯: ${status.error}`);

                    document.getElementById('status').textContent  =
                        `çŠ¶æ€: ${status.status}  (è¿›åº¦: ${status.metrics?.progress  || 0}%)`;

                    if (status.status  === "succeeded") {
                        status.output.forEach(img  => {
                            const imgNode = new Image();
                            imgNode.src  = img;
                            imgNode.onload  = () => {
                                document.getElementById('results').appendChild(imgNode);
                            };
                        });
                    } else if (status.status  !== "failed") {
                        setTimeout(checkStatus, 1500);
                    }
                };
                await checkStatus();

            } catch (error) {
                document.getElementById('status').textContent  = "é”™è¯¯: " + error.message;
                console.error("[DEBUG]",  error);
            } finally {
                btn.disabled  = false;
            }
        }
    </script>
</body>
</html>