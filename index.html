<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>多模型LoRA生成器</title>
    <style>
        .container { max-width: 800px; margin: 20px auto; padding: 20px; background: #f8f9fa; }
        .input-group { margin: 15px 0; }
        select, input[type="number"], textarea { width: 100%; padding: 8px; border: 1px solid #ddd; }
        button { background: #4CAF50; color: white; padding: 12px; width: 100%; border: none; cursor: pointer; }
        #preview { max-width: 512px; margin: 10px 0; border: 2px dashed #ccc; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(256px, 1fr)); gap: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>⚡ 多模型LoRA生成系统</h2>

        <!-- 核心交互模块 -->
        <div class="input-group">
            <label>选择LoRA模型：</label>
            <select id="modelSelect">
                <option value="1">赛博朋克增强版 v1.5</option>
                <option value="2">水墨艺术风格 v2.0</option>
            </select>
        </div>

        <div class="input-group">
            <label>上传参考图：</label>
            <input type="file" id="imageInput" accept="image/png, image/jpeg">
            <img id="preview">
        </div>

        <div class="input-group">
            <label>生成数量（1-4）：</label>
            <input type="number" id="numInput" min="1" max="4" value="1">
        </div>

        <div class="input-group">
            <label>文字描述：</label>
            <textarea id="prompt" rows="3" placeholder="例：未来城市夜景，霓虹灯光，赛博朋克风格"></textarea>
        </div>

        <button onclick="generate()">开始生成</button>
        <div id="status" style="margin:10px 0; color:#666;"></div>
        <div class="grid" id="results"></div>
    </div>

    <script>
        const API_TOKEN = "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";
        const MODEL_MAP = {
            "1": "https://huggingface.co/NNiuNUll/my-lora/resolve/main/1.safetensors",
            "2": "https://huggingface.co/NNiuNUll/my-lora/resolve/main/2.safetensors"
        };

        // 实时图片预览
        document.getElementById('imageInput').addEventListener('change',  function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload  = function(e) {
                document.getElementById('preview').src  = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        async function generate() {
            const btn = document.querySelector('button');
            btn.disabled  = true;
            document.getElementById('status').textContent  = "模型加载中...";

            try {
                // 输入验证
                const file = document.getElementById('imageInput').files[0];
                if (!file) throw new Error("请上传参考图像");
                if (file.size  > 5 * 1024 * 1024) throw new Error("图片大小超过5MB限制");

                // 构建多部分请求
                const formData = new FormData();
                formData.append('image',  file);
                formData.append('prompt',  document.getElementById('prompt').value);
                formData.append('num_images',  document.getElementById('numInput').value);
                formData.append('lora_scale',  0.7);

                // 动态模型加载
                const modelUrl = MODEL_MAP[document.getElementById('modelSelect').value];
                let response;
                for (let retry = 0; retry < 3; retry++) {
                    response = await fetch(modelUrl, {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${API_TOKEN}` },
                        body: formData
                    });
                    if (response.status  === 503) await new Promise(r => setTimeout(r, 30000));
                    else break;
                }

                // 处理响应
                if (!response.ok)  {
                    const error = await response.json();
                    throw new Error(`[${error.code}]  ${error.message}`);
                }

                // 渲染结果
                const blob = await response.blob();
                const img = document.createElement('img');
                img.src  = URL.createObjectURL(blob);
                img.style.boxShadow  = '0 4px 12px rgba(0,0,0,0.15)';
                document.getElementById('results').prepend(img);
                document.getElementById('status').textContent  = "生成成功！";

            } catch (error) {
                document.getElementById('status').textContent  = `错误: ${error.message}`;
                console.error("[DEBUG]",  error);
            } finally {
                btn.disabled  = false;
            }
        }
    </script>
</body>
</html>