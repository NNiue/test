<!DOCTYPE html>
<html>
<head>
<title>LoRA生成器 - 2025新版</title>
<style>
/* 保留所有原始CSS样式不变 */
body { font-family: Arial; max-width: 800px; margin: 20px auto; padding: 20px; }
input, select, textarea { display: block; margin: 10px 0; width: 100%; padding: 8px; }
button { background: #007bff; color: white; border: none; padding: 10px 20px; cursor: pointer; }
#results img { width: 256px; margin: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
#status { color: #d9534f; margin: 10px 0; }
</style>
</head>
<body>
<h2>LoRA图片生成器（HuggingFace适配版）</h2>
<input type="file" id="imageInput" accept="image/*">
<select id="modelSelect">
<option value="NNiuNUll/my-lora">赛博风格增强模型 v1</option>
</select>
<input type="number" id="num" value="1" min="1" max="4">
<textarea id="prompt" placeholder="示例：赛博朋克风格的未来城市，霓虹灯光，雨夜氛围"></textarea>
<button onclick="generate()">生成图片</button>
<div id="status"></div>
<div id="results"></div>

<script>
// ==== 核心修改部分开始 ====
const HF_API_TOKEN = "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";
const API_ENDPOINT = "https://api-inference.huggingface.co/models/NNiuNUll/my-lora";

async function generate() {
  const btn = document.querySelector('button');
  btn.disabled  = true;
  document.getElementById('status').textContent  = "正在生成...";

  try {
    // 保留原始图片处理逻辑
    const file = document.getElementById('imageInput').files[0];
    if (!file) throw new Error("请先上传参考图！");

    // 修改为HuggingFace专用请求格式
    const formData = new FormData();
    formData.append('image',  file);
    formData.append('inputs',  document.getElementById('prompt').value);
    formData.append('parameters',  JSON.stringify({
      num_outputs: parseInt(document.getElementById('num').value),
      lora_scale: 0.8,
      height: 1024,
      width: 1024
    }));

    // 修改API调用方式
    const response = await fetch(API_ENDPOINT, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${HF_API_TOKEN}`,
        "X-Wait-For-Model": "true"  // 防止模型加载延迟错误
      },
      body: formData
    });

    // 处理新API响应格式
    if (!response.ok)  {
      const errorData = await response.json();
      throw new Error(`API错误: ${errorData.error  || response.statusText}`);
    }

    // 直接获取生成图片（HuggingFace同步响应）
    const blob = await response.blob();
    const imgUrl = URL.createObjectURL(blob);
    const imgNode = new Image();
    imgNode.src  = imgUrl;
    document.getElementById('results').appendChild(imgNode);

    document.getElementById('status').textContent  = "生成成功！";

  } catch (error) {
    document.getElementById('status').textContent  = `错误: ${error.message}`;
    console.error(" 调试信息:", error);
  } finally {
    btn.disabled  = false;
  }
}
// ==== 核心修改部分结束 ====
</script>
</body>
</html>