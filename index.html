<!DOCTYPE html>
<html>
<head>
<title>LoRA生成器 - 2025专业版</title>
<style>
/* 优化视觉层次 */
body { font-family: 'Segoe UI', Arial; max-width: 800px; margin: 20px auto; padding: 25px; }
.input-group { margin: 15px 0; background: #f8f9fa; padding: 15px; border-radius: 8px; }
button { background: linear-gradient(135deg, #4a90e2, #63d471); transition: opacity 0.3s; }
button:disabled { opacity: 0.6; }
#results { display: grid; grid-template-columns: repeat(auto-fit, minmax(256px, 1fr)); gap: 15px; }
.status-indicator { height: 4px; background: #e0e0e0; margin: 10px 0; border-radius: 2px; }
.progress { background: #63d471; width: 0%; transition: width 0.3s ease; }
</style>
</head>
<body>
<h2>🔮 LoRA生成器（HuggingFace优化版）</h2>

<div class="input-group">
  <select id="taskType" onchange="toggleInput()">
    <option value="text-to-image">文本生成图像</option>
    <option value="image-to-image">图像风格转换</option>
  </select>
</div>

<div class="input-group" id="imageUpload" style="display: none;">
  <input type="file" id="imageInput" accept="image/png, image/jpeg">
</div>

<div class="input-group">
  <textarea id="prompt" placeholder="输入详细描述（建议包含：主体/风格/色彩/细节）"></textarea>
</div>

<div class="input-group">
  <button onclick="generate()">立即生成</button>
  <div class="status-indicator"><div class="progress"></div></div>
  <div id="status"></div>
</div>

<div id="results"></div>

<script>
const HF_API_TOKEN = "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";
const MODEL_REPO = "NNiuNUll/my-lora";

// ===== 核心逻辑优化 =====
async function generate() {
  const btn = document.querySelector('button');
  const taskType = document.getElementById('taskType').value;
  btn.disabled  = true;
  document.querySelector('.progress').style.width  = '30%';

  try {
    // 动态构建API端点
    const apiEndpoint = `https://api-inference.huggingface.co/pipeline/${taskType}/${MODEL_REPO}`;

    // 构建合规请求体
    const payload = new FormData();
    payload.append('inputs',  document.getElementById('prompt').value);

    if (taskType === 'image-to-image') {
      const file = document.getElementById('imageInput').files[0];
      if (!file) throw new Error("请上传参考图像");
      payload.append('image',  file);
    }

    // 添加模型参数
    payload.append('parameters',  JSON.stringify({
      lora_scale: 0.8,
      height: 1024,
      width: 1024,
      num_images: 1
    }));

    // 智能重试机制
    let response;
    for (let retry = 0; retry < 3; retry++) {
      response = await fetch(apiEndpoint, {
        method: "POST",
        headers: { "Authorization": `Bearer ${HF_API_TOKEN}` },
        body: payload
      });

      if (response.status  === 503) {
        const waitTime = response.headers.get('Retry-After')  || 30;
        await new Promise(resolve => setTimeout(resolve, waitTime * 1000));
      } else {
        break;
      }
    }

    document.querySelector('.progress').style.width  = '70%';

    // 错误处理优化
    if (!response.ok)  {
      const errorData = await response.json();
      throw new Error(`[${errorData.error_type}]  ${errorData.error}`);
    }

    // 结果渲染
    const blob = await response.blob();
    const img = document.createElement('img');
    img.src  = URL.createObjectURL(blob);
    img.onload  = () => document.querySelector('.progress').style.width  = '100%';
    document.getElementById('results').prepend(img);

  } catch (error) {
    document.getElementById('status').textContent  = `错误: ${error.message}`;
    console.error('[DEBUG]',  error);
  } finally {
    setTimeout(() => {
      btn.disabled  = false;
      document.querySelector('.progress').style.width  = '0%';
    }, 1000);
  }
}

// ===== 辅助功能 =====
function toggleInput() {
  const taskType = document.getElementById('taskType').value;
  document.getElementById('imageUpload').style.display  =
    taskType === 'image-to-image' ? 'block' : 'none';
}
</script>
</body>
</html>