<!DOCTYPE html>
<html>
<head>
<title>LoRAç”Ÿæˆå™¨ - 2025ä¸“ä¸šç‰ˆ</title>
<style>
/* ä¼˜åŒ–è§†è§‰å±‚æ¬¡ */
body { font-family: 'Segoe UI', Arial; max-width: 800px; margin: 20px auto; padding: 25px; }
.input-group { margin: 15px 0; background: #f8f9fa; padding: 15px; border-radius: 8px; }
button { background: linear-gradient(135deg, #4a90e2, #63d471); transition: opacity 0.3s; }
button:disabled { opacity: 0.6; }
#results { display: grid; grid-template-columns: repeat(auto-fit, minmax(256px, 1fr)); gap: 15px; }
.status-indicator { height: 4px; background: #e0e0e0; margin: 10px 0; border-radius: 2px; }
.progress { background: #63d471; width: 0%; transition: width 0.3s ease; }
</style>
</head>
<body>
<h2>ğŸ”® LoRAç”Ÿæˆå™¨ï¼ˆHuggingFaceä¼˜åŒ–ç‰ˆï¼‰</h2>

<div class="input-group">
  <select id="taskType" onchange="toggleInput()">
    <option value="text-to-image">æ–‡æœ¬ç”Ÿæˆå›¾åƒ</option>
    <option value="image-to-image">å›¾åƒé£æ ¼è½¬æ¢</option>
  </select>
</div>

<div class="input-group" id="imageUpload" style="display: none;">
  <input type="file" id="imageInput" accept="image/png, image/jpeg">
</div>

<div class="input-group">
  <textarea id="prompt" placeholder="è¾“å…¥è¯¦ç»†æè¿°ï¼ˆå»ºè®®åŒ…å«ï¼šä¸»ä½“/é£æ ¼/è‰²å½©/ç»†èŠ‚ï¼‰"></textarea>
</div>

<div class="input-group">
  <button onclick="generate()">ç«‹å³ç”Ÿæˆ</button>
  <div class="status-indicator"><div class="progress"></div></div>
  <div id="status"></div>
</div>

<div id="results"></div>

<script>
const HF_API_TOKEN = "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";
const MODEL_REPO = "NNiuNUll/my-lora";

// ===== æ ¸å¿ƒé€»è¾‘ä¼˜åŒ– =====
async function generate() {
  const btn = document.querySelector('button');
  const taskType = document.getElementById('taskType').value;
  btn.disabled  = true;
  document.querySelector('.progress').style.width  = '30%';

  try {
    // åŠ¨æ€æ„å»ºAPIç«¯ç‚¹
    const apiEndpoint = `https://api-inference.huggingface.co/pipeline/${taskType}/${MODEL_REPO}`;

    // æ„å»ºåˆè§„è¯·æ±‚ä½“
    const payload = new FormData();
    payload.append('inputs',  document.getElementById('prompt').value);

    if (taskType === 'image-to-image') {
      const file = document.getElementById('imageInput').files[0];
      if (!file) throw new Error("è¯·ä¸Šä¼ å‚è€ƒå›¾åƒ");
      payload.append('image',  file);
    }

    // æ·»åŠ æ¨¡å‹å‚æ•°
    payload.append('parameters',  JSON.stringify({
      lora_scale: 0.8,
      height: 1024,
      width: 1024,
      num_images: 1
    }));

    // æ™ºèƒ½é‡è¯•æœºåˆ¶
    let response;
    for (let retry = 0; retry < 3; retry++) {
      response = await fetch(apiEndpoint, {
        method: "POST",
        headers: { "Authorization": `Bearer ${HF_API_TOKEN}` },
        body: payload
      });

      if (response.status  === 503) {
        const waitTime = response.headers.get('Retry-After')  || 30;
        await new Promise(resolve => setTimeout(resolve, waitTime * 1000));
      } else {
        break;
      }
    }

    document.querySelector('.progress').style.width  = '70%';

    // é”™è¯¯å¤„ç†ä¼˜åŒ–
    if (!response.ok)  {
      const errorData = await response.json();
      throw new Error(`[${errorData.error_type}]  ${errorData.error}`);
    }

    // ç»“æœæ¸²æŸ“
    const blob = await response.blob();
    const img = document.createElement('img');
    img.src  = URL.createObjectURL(blob);
    img.onload  = () => document.querySelector('.progress').style.width  = '100%';
    document.getElementById('results').prepend(img);

  } catch (error) {
    document.getElementById('status').textContent  = `é”™è¯¯: ${error.message}`;
    console.error('[DEBUG]',  error);
  } finally {
    setTimeout(() => {
      btn.disabled  = false;
      document.querySelector('.progress').style.width  = '0%';
    }, 1000);
  }
}

// ===== è¾…åŠ©åŠŸèƒ½ =====
function toggleInput() {
  const taskType = document.getElementById('taskType').value;
  document.getElementById('imageUpload').style.display  =
    taskType === 'image-to-image' ? 'block' : 'none';
}
</script>
</body>
</html>